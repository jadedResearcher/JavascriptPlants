<html>
	<head>
		<title>Procedural Plants Simulation</title>
		<script type = "text/javascript" src="scripts/Bamboo/BambooBranch.js"></script>
		<script type = "text/javascript" src="scripts/Bamboo/BambooSeed.js"></script>
		<script type = "text/javascript" src="scripts/Bamboo/BambooLeafBranch.js"></script>
		<script type = "text/javascript" src="scripts/Bamboo/BambooLeaf.js"></script>
		<script type = "text/javascript" src="scripts/jquery-1.4.2.min.js"></script>
		<script type = "text/javascript" src="scripts/jquery.timers-1.2.js"></script>
		<script type = "text/javascript" src="scripts/raphael-min.js"></script>
		
		<script type = "text/javascript">
		
			var seed_list;
			var seed_sprite_list;
			var paper;
			var root_list;
			var root_sprite_list;
			var speed = 50;
			var branch_list;
			var branch_sprite_list;
			var leaf_list;
			var leaf_sprite_list;
			var floating_list;
			var floating_sprite_list;
			var set_to_tick = 0;
			var wind = 1;
			var wind_direction = -1;
			var wind_velocity_sprite;
			
	
			//alert(seed.test());
			
			window.onload = function(){
				paper = new Raphael(document.getElementById('sim'),1000,1000);
				
				var ground = paper.rect(0,0,1000,1000);
				ground.attr("fill", "#996600");
			
				var sky = paper.rect(0,0,1000,800);
				sky.attr("fill", "45-#fff-#659ec7");
			
				seed_list = new Array();
				seed_sprite_list = new Array();
				root_list = new Array();
				root_sprite_list = new Array();
			    branch_list = new Array();
				branch_sprite_list = new Array();
				leaf_list = new Array();
				leaf_sprite_list = new Array();
				floating_list = new Array();
				floating_sprite_list = new Array();
				makeSeeds();
	    	    startTimer();
	    	   // startFloatTimer();
	    	    
		    } //end on load
		    
		    //make several seeds, which will sprout one at a time
		    function makeSeeds(){
	    	  //subsequent seeds
	    	  for(var i = 0; i < 3; i++){
				 position = (i+1) * 250
	    	 	 seed = new BambooSeed(position,800,1000,1000);
		  	 	 seed_list.push(seed);
			 	 seed_sprite_list.push(paper.path(seed.path));
			 	 seed_sprite_list[seed_sprite_list.length - 1].attr({fill: seed.color, stroke: seed.stroke});
	    	  
	    	  }	   

		    };
		    

			function startTimer(){
				$(document).everyTime(speed,function(i) {
	            	tick();
	            	check_for_dead();
	            	check_for_stasis();
					
					}, 0);
			};
			
			//floating objects don't move as fast
			function startFloatTimer(){
				$(document).everyTime(speed*4 ,function(i) {
				//don't bother rendering effects if the system is still growing
						if(seed_list.length == 0){
							float_tick();
						}
					}, 0);
			};
			
			
			function float_tick(){
				//set the wind direction
				if(Math.random() * 100 < 200){
					wind_direction = wind_direction * -1;
				}
				//set the wind amount
				wind = wind + wind_direction * (Math.random() * 5);
				wind_velocity_sprite.attr('text', "Wind Velocity: " + Math.round(wind));
				var number_tick = floating_list.length;
				//can't tick on ALL of them or would chug
				//so look at 50 at a time
				if(number_tick > 150){
					number_tick = 150;
				}
				    if((set_to_tick + 1) * 100 > floating_list.length){
						set_to_tick = 0;
					}else{
						set_to_tick = set_to_tick + 1;
					}
				for(var i = 0; i < number_tick; i++){
					//increment the set i'm looking at, or reset

					var index = set_to_tick * 100 + i;
					if(floating_list[index]){
						floating_list[index].tick(floating_sprite_list[index], wind);
						//if the leaf is on the ground, stop floating
						if(floating_list[index].on_ground){
							floating_sprite_list.splice(index,1);
							floating_list.splice(index,1);
						}
					}
				}//end floating for loop
			};
			
			//tick all seeds, roots, etc.
			function tick(){
				if(seed_list.length != 0){
					seed_list[0].tick(root_list, root_sprite_list, branch_list, branch_sprite_list);
				}
				
				for(var i in leaf_list){
					leaf_list[i].tick(leaf_sprite_list[i], wind);
				}//end leaf for loop
				
				for(var i in branch_list){
					branch_list[i].tick(branch_list, branch_sprite_list, leaf_list, leaf_sprite_list, i);
				}//end branch for loop
				
				for(var i in root_list){
					root_list[i].tick(root_list, root_sprite_list, i);
				}//end root for loop
				
		}//end tick
		
			//stops objects in stasis from ticking
			//by removing them from their respective lists
			//but does NOT stop rendering them.
			function check_for_stasis(){
				for(var i in seed_list){
					if(seed_list[i].is_stasis){
					   if(seed_list[i].y > 0 && seed_list[i].num_seed_children == 0){//reproduce
					       for(var j = 0; j< 1; j++){
					         sign = randomSign();
					         if(j%2 == 11110){
					             sign = randomSign();
					         }
	    	 	                         seed = new BambooSeed(seed_list[i].x+(Math.random()*50+100)*sign,seed_list[i].y+Math.random()*50,1000,1000);
	    	 	                         //inherit parents color
		      			         seed.red = seed_list[i].red;
		      			         seed.blue = seed_list[i].blue; 
		      			         seed.green = seed_list[i].green; 
	    	 	                         seed_list[i].num_seed_children ++;
		  	 	                 seed_list.push(seed);
			 	                 seed_sprite_list.push(paper.path(seed.path));
			 	                 seed_sprite_list[seed_sprite_list.length - 1].attr({fill: seed.color, stroke: seed.stroke});
			 	               }//end spawning new seeds
			 	           }//end checking if should spawn
			 	           //get rid of old seed
					   seed_sprite_list.splice(i,1);
					   seed_list.splice(i,1);
					}//end if stasis
				}//end all seeds
				
				
				for(var i in branch_list){
					if(branch_list[i].is_stasis){
						branch_sprite_list.splice(i,1);
						branch_list.splice(i,1);
					}//end if stasis
				}//end all branches
				
				for(var i in leaf_list){
					if(leaf_list[i].is_stasis || leaf_list[i].is_floating){
						floating_list.push(leaf_list[i]);
						floating_sprite_list.push(leaf_sprite_list[i]);
						leaf_sprite_list.splice(i,1);
						leaf_list.splice(i,1);
					}//end if stasis

				}//end all leaves
			}
			
			function randomSign(){
			  var arr = [1,-1];
			  var ret = arr[Math.floor(Math.random() * 2)];
			  return ret;
			}
			
			//goes through each type of object
			//and removes everything that is "dead"
			function check_for_dead(){
			
				for(var i in seed_list){
					if(seed_list[i].is_dead){
						//seed_sprite_list[i].animate({opacity: 0, 'stroke-opacity': 0, 'fill-opacity': 0}, 1000);
						seed_sprite_list[i].hide();
						seed_list.splice(i,1);
						seed_sprite_list.splice(i,1);
						
						//now, make a replacement seed
		      			        var seed = new BambooSeed(500,410,1000,500);
		  	  			seed_list.push(seed);
			  			seed_sprite_list.push(paper.path(new Seed(500,410,1000,500).path));
			  			seed_sprite_list[seed_sprite_list.length - 1].attr({fill: seed.color, stroke: seed.stroke});
	    	   
					}//end if dead
				}//end for seeds
				
				for(var i in branch_list){
					if(branch_list[i].is_dead){
						//branch_sprite_list[i].animate({opacity: 0, 'stroke-opacity': 0, 'fill-opacity': 0}, 1000);
						branch_sprite_list[i].hide();
						branch_list.splice(i,1);
						branch_sprite_list.splice(i,1);						
					}//end if dead
				}//end for branches
				
				for(var i in leaf_list){
					if(leaf_list[i].is_dead){
						//leaf_sprite_list[i].animate({opacity: 0, 'stroke-opacity': 0, 'fill-opacity': 0}, 1000);
						leaf_sprite_list[i].hide();
						leaf_list.splice(i,1);
						leaf_sprite_list.splice(i,1);						
					}//end if dead
				}//end for leaves
				
				for(var i in floating_list){
					if(floating_list[i].is_dead){
						//floating_sprite_list[i].animate({opacity: 0, 'stroke-opacity': 0, 'fill-opacity': 0}, 1000);
						floating_sprite_list[i].hide();
						floating_list.splice(i,1);
						floating_sprite_list.splice(i,1);						
					}//end if dead
				}//end for floatingers
			}//end check for dead
		</script>
	</head>

	<body>
		
		<div id = "sim">

		</div>
	</body>
</html>
